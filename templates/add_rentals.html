<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o ƒê∆°n Thu√™ S√°ch</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .book-entry td {
            vertical-align: middle;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .total-price {
            font-weight: bold;
            font-size: 1.2em;
        }
        .remove-book {
            padding: 5px 10px;
        }
        @media (max-width: 767.98px) {
            .table {
                display: block;
            }
            .table thead {
                display: none;
            }
            .table tbody, .table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 10px;
            }
            .table td {
                display: block;
                text-align: left;
                padding: 5px 10px;
                border: none;
            }
            .table td:before {
                content: attr(data-label);
                font-weight: bold;
                display: inline-block;
                width: 100px;
            }
            .table td input, .table td span {
                width: calc(100% - 110px);
                display: inline-block;
            }
            .table td .remove-book {
                width: auto;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Menu ƒëi·ªÅu h∆∞·ªõng -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">üìö BOOKSTART</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('views.index') }}">üìñ Qu·∫£n l√Ω S√°ch</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('customer_views.manage_customers') }}">üë§ Qu·∫£n l√Ω Kh√°ch h√†ng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('rental_views.manage_rentals') }}">üìñ Qu·∫£n l√Ω ƒë∆°n thu√™</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4">T·∫°o ƒê∆°n Thu√™ S√°ch</h2>

        <!-- Form nh·∫≠p th√¥ng tin kh√°ch h√†ng -->
        <div class="card p-4 mb-3">
            <h5>Th√¥ng tin kh√°ch h√†ng</h5>
            <div class="mb-3">
                <label class="form-label">T√™n kh√°ch h√†ng</label>
                <input type="text" id="customer_name" class="form-control" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" required>
            </div>
            <div class="mb-3">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="text" id="customer_phone" class="form-control" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
            </div>
        </div>

        <!-- Form nh·∫≠p th√¥ng tin s√°ch thu√™ -->
        <div class="card p-4 mb-3">
            <h5>Danh s√°ch s√°ch thu√™</h5>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>ID s√°ch</th>
                            <th>T√™n s√°ch</th>
                            <th class="d-none d-md-table-cell">Gi√° thu√™</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th class="d-none d-md-table-cell">T·ªïng ti·ªÅn s√°ch</th>
                            <th>Ng√†y tr·∫£</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="books_list">
                        <tr class="book-entry" data-index="0">
                            <td data-label="ID s√°ch"><input type="number" class="form-control book_id" placeholder="ID s√°ch" min="1" required></td>
                            <td data-label="T√™n s√°ch"><span class="book_title"></span></td>
                            <td data-label="Gi√° thu√™" class="d-none d-md-table-cell"><span class="rental_price"></span></td>
                            <td data-label="S·ªë l∆∞·ª£ng"><input type="number" class="form-control rental_quantity" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1" required></td>
                            <td data-label="T·ªïng ti·ªÅn s√°ch" class="d-none d-md-table-cell"><span class="item_total">0</span> VND</td>
                            <td data-label="Ng√†y tr·∫£"><input type="datetime-local" class="form-control return_due_date" required></td>
                            <td data-label="H√†nh ƒë·ªông">
                                <button class="btn btn-danger btn-sm remove-book" title="X√≥a">üóëÔ∏è</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button id="add_book" class="btn btn-primary mt-2">Th√™m s√°ch</button>
            <div class="mt-3 total-price">
                T·ªïng ti·ªÅn: <span id="total_price">0</span> VND
            </div>
        </div>

        <!-- N√∫t g·ª≠i ƒë∆°n thu√™ -->
        <button id="submit_rental" class="btn btn-success">T·∫°o ƒê∆°n Thu√™</button>

        <!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
        <div id="message" class="mt-3"></div>
    </div>

    <script>
        $(document).ready(function() {
            let bookIndex = 0;

            // L·∫•y th√¥ng tin s√°ch khi nh·∫≠p ID s√°ch
            $(document).on("input", ".book_id", function() {
                const row = $(this).closest("tr");
                const bookId = $(this).val();
                const index = row.data("index");
                const messageDiv = $("#message");

                if (!bookId) {
                    row.find(".book_title").text("");
                    row.find(".rental_price").text("");
                    row.find(".item_total").text("0");
                    updateTotalPrice();
                    return;
                }

                $.ajax({
                    url: `/books/${bookId}/info`,
                    type: "GET",
                    success: function(data) {
                        row.find(".book_title").text(data.title);
                        row.find(".rental_price").text(`${data.rental_price} VND`);
                        row.find(".rental_quantity").attr("max", data.quantity);
                        updateItemTotal(row);
                        messageDiv.html("");
                    },
                    error: function(xhr) {
                        messageDiv.html(`<div class="alert alert-danger">${xhr.responseJSON.message}</div>`);
                        row.find(".book_title").text("");
                        row.find(".rental_price").text("");
                        row.find(".item_total").text("0");
                        updateTotalPrice();
                    }
                });
            });

            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn cho m·ªôt s√°ch
            function updateItemTotal(row) {
                const quantity = parseInt(row.find(".rental_quantity").val()) || 0;
                const priceText = row.find(".rental_price").text().replace(" VND", "");
                const price = parseFloat(priceText) || 0;
                const itemTotal = quantity * price;
                row.find(".item_total").text(itemTotal);
                updateTotalPrice();
            }

            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn to√†n ƒë∆°n
            function updateTotalPrice() {
                let total = 0;
                $("#books_list tr").each(function() {
                    const itemTotal = parseFloat($(this).find(".item_total").text()) || 0;
                    total += itemTotal;
                });
                $("#total_price").text(total);
            }

            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn khi thay ƒë·ªïi s·ªë l∆∞·ª£ng
            $(document).on("input", ".rental_quantity", function() {
                const row = $(this).closest("tr");
                updateItemTotal(row);
            });

            // Th√™m d√≤ng m·ªõi ƒë·ªÉ nh·∫≠p th√¥ng tin s√°ch
            $("#add_book").click(function() {
                bookIndex++;
                $("#books_list").append(`
                    <tr class="book-entry" data-index="${bookIndex}">
                        <td data-label="ID s√°ch"><input type="number" class="form-control book_id" placeholder="ID s√°ch" min="1" required></td>
                        <td data-label="T√™n s√°ch"><span class="book_title"></span></td>
                        <td data-label="Gi√° thu√™" class="d-none d-md-table-cell"><span class="rental_price"></span></td>
                        <td data-label="S·ªë l∆∞·ª£ng"><input type="number" class="form-control rental_quantity" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1" required></td>
                        <td data-label="T·ªïng ti·ªÅn s√°ch" class="d-none d-md-table-cell"><span class="item_total">0</span> VND</td>
                        <td data-label="Ng√†y tr·∫£"><input type="datetime-local" class="form-control return_due_date" required></td>
                        <td data-label="H√†nh ƒë·ªông">
                            <button class="btn btn-danger btn-sm remove-book" title="X√≥a">üóëÔ∏è</button>
                        </td>
                    </tr>
                `);
            });

            // X√≥a d√≤ng nh·∫≠p s√°ch
            $(document).on("click", ".remove-book", function() {
                $(this).closest("tr").remove();
                updateTotalPrice();
            });

            // G·ª≠i y√™u c·∫ßu t·∫°o ƒë∆°n thu√™
            $("#submit_rental").click(function() {
                const customer_name = $("#customer_name").val();
                const customer_phone = $("#customer_phone").val();
                const books = [];
                let valid = true;

                // L·∫•y danh s√°ch s√°ch thu√™
                $("#books_list tr").each(function() {
                    const book_id = $(this).find(".book_id").val();
                    const rental_quantity = $(this).find(".rental_quantity").val();
                    const return_due_date = $(this).find(".return_due_date").val();
                    const book_title = $(this).find(".book_title").text();

                    if (book_id && rental_quantity && return_due_date && book_title) {
                        books.push({
                            book_id: parseInt(book_id),
                            rental_quantity: parseInt(rental_quantity),
                            return_due_date: new Date(return_due_date).toISOString()
                        });
                    } else {
                        valid = false;
                    }
                });

                if (!customer_name || !customer_phone || books.length === 0 || !valid) {
                    $("#message").html('<div class="alert alert-danger">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ki·ªÉm tra ID s√°ch!</div>');
                    return;
                }

                // G·ª≠i API t·∫°o ƒë∆°n thu√™
                $.ajax({
                    url: "/rentals",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        customer_name: customer_name,
                        customer_phone: customer_phone,
                        books: books
                    }),
                    success: function(response) {
                        $("#message").html(`<div class="alert alert-success">${response.message} ID: ${response.rental_id}, T·ªïng ti·ªÅn: ${response.total_price} VND</div>`);
                        // Reset form
                        $("#customer_name").val("");
                        $("#customer_phone").val("");
                        $("#books_list").html(`
                            <tr class="book-entry" data-index="0">
                                <td data-label="ID s√°ch"><input type="number" class="form-control book_id" placeholder="ID s√°ch" min="1" required></td>
                                <td data-label="T√™n s√°ch"><span class="book_title"></span></td>
                                <td data-label="Gi√° thu√™" class="d-none d-md-table-cell"><span class="rental_price"></span></td>
                                <td data-label="S·ªë l∆∞·ª£ng"><input type="number" class="form-control rental_quantity" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1" required></td>
                                <td data-label="T·ªïng ti·ªÅn s√°ch" class="d-none d-md-table-cell"><span class="item_total">0</span> VND</td>
                                <td data-label="Ng√†y tr·∫£"><input type="datetime-local" class="form-control return_due_date" required></td>
                                <td data-label="H√†nh ƒë·ªông">
                                    <button class="btn btn-danger btn-sm remove-book" title="X√≥a">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `);
                        $("#total_price").text("0");
                        bookIndex = 0;
                    },
                    error: function(xhr) {
                        $("#message").html(`<div class="alert alert-danger">${xhr.responseJSON.message}</div>`);
                    }
                });
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
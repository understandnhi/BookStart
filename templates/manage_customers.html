<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Kh√°ch h√†ng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .table-container {
            width: 90%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
           <!-- üèó MENU ƒêI·ªÄU H∆Ø·ªöNG -->

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">üìö BOOKSTART</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('views.index') }}">üìñ Qu·∫£n l√Ω S√°ch</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('customer_views.manage_customers') }}">üë§ Qu·∫£n l√Ω Kh√°ch h√†ng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('rental_views.manage_rentals') }}">üìñ Qu·∫£n l√Ω ƒë∆°n thu√™</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <h2 class="text-center fw-bold">Qu·∫£n L√Ω Kh√°ch H√†ng</h2>
    <div class="table-container">
        <div class="d-flex justify-content-between mb-3">
            <input type="text" id="searchInput" class="form-control w-50" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ t√¨m ki·∫øm...">
            <button class="btn btn-primary" onclick="searchCustomers()">üîç T√¨m ki·∫øm</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="openAddPopup()">+ Th√™m kh√°ch h√†ng</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>ID</th>
                        <th>T√™n</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="customerTable"></tbody>
            </table>
        </div>
    </div>
</div>


           <!--POP UP TH√äM/S·ª¨A  -->

<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Th√™m kh√°ch h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="customerId">               <!-- ·∫®N ID ƒêI -->

                <label>T√™n:</label>
                <input type="text" id="name" class="form-control mb-2">
                <label>S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="phone" class="form-control mb-2">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

                      <!--POP UP X√ÅC NH·∫¨N X√ìA -->

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y kh√¥ng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√≥a</button>
            </div>
        </div>
    </div>
</div>




<script>
    document.addEventListener("DOMContentLoaded", loadCustomers);

    function loadCustomers() {
        fetch("/customers")
            .then(response => response.json())
            .then(data => renderTable(data));
    }

    function renderTable(data) {
        let tableBody = document.getElementById("customerTable");
        tableBody.innerHTML = "";
        data.forEach(customer => {
            tableBody.innerHTML += `<tr>
                <td>${customer.id}</td>
                <td>${customer.name}</td>
                <td>${customer.phone}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick='openEditPopup(${JSON.stringify(customer)})'>‚úèÔ∏è S·ª≠a</button>
                    <button class="btn btn-danger btn-sm" onclick="confirmDelete(${customer.id})">üóëÔ∏è X√≥a</button>
                </td>
            </tr>`;
        });
    }

    function searchCustomers() {
        let keyword = document.getElementById("searchInput").value;
        fetch(`/search_customer/${keyword}`)
            .then(response => response.json())
            .then(data => renderTable(data))
            .catch(() => alert("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!"));
    }

    function openAddPopup() {
        document.getElementById("modalTitle").innerText = "Th√™m kh√°ch h√†ng";
        document.getElementById("customerId").value = "";
        document.getElementById("name").value = "";
        document.getElementById("phone").value = "";
    }

    function openEditPopup(customer) {
        document.getElementById("modalTitle").innerText = "S·ª≠a kh√°ch h√†ng";
        document.getElementById("customerId").value = customer.id;
        document.getElementById("name").value = customer.name;
        document.getElementById("phone").value = customer.phone;
        new bootstrap.Modal(document.getElementById('customerModal')).show();
    }

    function saveCustomer() {
        let id = document.getElementById("customerId").value;
        let name = document.getElementById("name").value;
        let phone = document.getElementById("phone").value;
        let data = { name, phone };

        let url = id ? `/update_customer/${id}` : "/add_customer";
        let method = id ? "PUT" : "POST";

        fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        })
        .then(() => {
            loadCustomers();
            bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
        });
    }

    function confirmDelete(id) {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y kh√¥ng?")) {
            deleteCustomer(id);
        }
    }

    function deleteCustomer(id) {
        fetch(`/delete_customer/${id}`, { method: "DELETE" })
            .then(() => loadCustomers());
    }




    let deleteId = null; // Bi·∫øn l∆∞u ID kh√°ch h√†ng c·∫ßn x√≥a

    function confirmDelete(id) {
        deleteId = id; // L∆∞u ID ƒë·ªÉ s·ª≠ d·ª•ng khi nh·∫•n n√∫t "X√≥a"
        new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show(); // Hi·ªán modal
    }

    // Khi nh·∫•n n√∫t "X√≥a" trong modal
    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
        if (deleteId !== null) {
            deleteCustomer(deleteId);
            deleteId = null; // Reset ID sau khi x√≥a
            bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide(); // ·∫®n modal
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>